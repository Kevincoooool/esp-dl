# ESP32-S3 实时坐姿检测摄像头系统

基于原有LCD摄像头项目增强，集成YOLO11n-pose AI模型，实现实时坐姿检测功能。

## 🌟 功能特点

### 核心功能
- **实时摄像头预览**：240x180像素LCD显示
- **AI姿态检测**：基于YOLO11n-pose模型的17个关键点检测
- **智能坐姿分析**：自动识别4种坐姿状态
- **实时状态显示**：图标+文字的直观状态提示
- **检测开关控制**：可随时开启/关闭姿态检测功能

### 检测状态
- ✅ **正常坐姿**：理想的工作/学习姿势
- 😴 **趴桌**：头部过低，可能在睡觉或过度疲劳
- 🤔 **歪头**：头部倾斜角度过大
- 🐢 **驼背**：头部过度前倾，脊椎姿势不良

## 🛠️ 硬件要求

### 必需硬件
- **ESP32-S3开发板** (16MB Flash + 8MB PSRAM推荐)
- **OV2640摄像头模块**
- **240x240 SPI LCD显示屏**
- **触摸传感器**（可选，用于开关控制）

### 推荐配置
- ESP32-S3-DevKitC-1 开发板
- ESP32-S3-EYE 或类似的摄像头开发板
- GC9A01/ST7789等SPI LCD

## 📋 软件依赖

### ESP-IDF环境
- ESP-IDF v5.3.1 或更高版本
- ESP-DL深度学习框架
- COCO-Pose模型组件

### Python依赖（如需自定义模型）
```bash
pip install ultralytics torch onnx ppq
```

## 🚀 快速开始

### 1. 环境设置
```bash
# 设置ESP-IDF环境
cd F:\Espressif\frameworks\esp-idf-v5.4.1
.\export.ps1

# 进入项目目录  
cd F:\GitHub\esp-dl\examples\8.lcd_camera_lvgl_v8
```

### 2. 编译和烧录
```bash
# 配置项目（可选）
idf.py menuconfig

# 编译项目
idf.py build

# 烧录到设备
idf.py flash monitor
```

### 3. 首次运行
1. 系统启动后会显示摄像头画面
2. 底部状态栏显示当前坐姿检测结果
3. 右侧开关可控制检测功能开启/关闭
4. 检测结果会实时更新显示

## 🔧 系统架构

### 软件架构
```
┌─────────────────────────────────────┐
│              LVGL GUI               │
├─────────────────────────────────────┤
│         摄像头显示 + 状态UI          │
├─────────────────────────────────────┤
│            坐姿分析器                │
├─────────────────────────────────────┤
│          YOLO11n-pose模型           │
├─────────────────────────────────────┤
│           ESP-DL推理引擎            │
├─────────────────────────────────────┤
│         ESP32-S3硬件平台            │
└─────────────────────────────────────┘
```

### 数据流程
1. **图像采集**：OV2640摄像头 → RGB565格式
2. **显示更新**：摄像头画面 → LVGL显示
3. **AI推理**：每5帧进行一次姿态检测
4. **坐姿分析**：17个关键点 → 坐姿状态判断
5. **状态显示**：检测结果 → UI更新

## ⚙️ 配置选项

### 检测参数调整
在`posture_analyzer.cpp`中可调整检测阈值：

```cpp
// 构造函数中的默认设置
head_tilt_threshold = 15.0f;      // 歪头角度阈值（度）
lying_height_ratio = 0.3f;       // 趴桌高度比例阈值
hunch_distance_ratio = 0.15f;    // 驼背距离比例阈值
```

### 性能优化
```cpp
// 在page_cam.cpp中调整检测频率
if (detection_count % 5 != 0) {  // 每5帧检测一次
    return;
}

// 调整任务延迟
vTaskDelay(pdMS_TO_TICKS(100));  // 100ms延迟
```

### 显示配置
```cpp
// 在imgcam_init()中调整UI布局
lv_obj_set_size(img_cam, 240, 180);     // 摄像头显示区域
lv_obj_set_size(status_container, 240, 50);  // 状态显示区域
```

## 📊 性能指标

### 检测性能
- **推理速度**：约200-300ms/帧（每5帧检测）
- **检测精度**：基于COCO数据集训练的YOLO11n-pose
- **内存使用**：~8MB PSRAM（模型加载）
- **帧率**：10-15 FPS（显示+检测）

### 资源使用
- **Flash**：~8MB（包含模型文件）
- **PSRAM**：~12MB（运行时）
- **CPU负载**：核心0（LVGL），核心1（AI推理）

## 🐛 故障排除

### 常见问题

#### 1. 编译错误
**问题**：找不到ESP-DL组件
**解决**：
```bash
# 确保ESP-DL路径正确
export ESP_DL_PATH=/path/to/esp-dl
# 或在CMakeLists.txt中检查EXTRA_COMPONENT_DIRS
```

#### 2. 运行时错误
**问题**：模型加载失败
**解决**：
- 检查PSRAM是否启用
- 确认分区表中coco_pose分区大小
- 验证模型文件是否正确烧录

#### 3. 检测不准确
**问题**：坐姿检测误报
**解决**：
- 改善环境光照条件
- 调整摄像头角度和距离
- 修改检测阈值参数
- 确保人体在摄像头视野中心

#### 4. 性能问题
**问题**：系统运行缓慢
**解决**：
- 降低检测频率（修改%5为%10）
- 减少任务优先级
- 关闭不必要的日志输出
- 使用ESP32-P4获得更好性能

### 调试技巧
```bash
# 启用详细日志
idf.py menuconfig → Component config → Log output → Default log verbosity → Debug

# 监控内存使用
# 在代码中添加
ESP_LOGI(TAG, "Free heap: %d bytes", esp_get_free_heap_size());

# 性能分析
# 使用esp_timer测量各函数执行时间
```

## 🔧 自定义开发

### 添加新的坐姿检测
1. 在`PostureState`枚举中添加新状态
2. 在`PostureAnalyzer`中实现检测算法
3. 更新状态名称和图标映射

### 集成其他AI模型
1. 替换COCO-Pose为自定义模型
2. 修改`init_posture_detection()`函数
3. 调整图像预处理参数

### UI界面定制
1. 修改`imgcam_init()`中的LVGL代码
2. 调整颜色、字体、布局
3. 添加新的控件和交互

## 📈 扩展功能建议

### 短期扩展
- [ ] 添加声音提醒功能
- [ ] 统计不良坐姿时长
- [ ] 支持多人检测
- [ ] 添加设置页面

### 长期规划  
- [ ] WiFi连接和数据上传
- [ ] 手机APP远程监控
- [ ] 健康报告生成
- [ ] 云端AI模型更新

## 📞 技术支持

### 获取帮助
1. **查看日志**：通过串口监控获取详细错误信息
2. **检查硬件**：确认所有连接正确无误
3. **参考文档**：阅读ESP-DL和LVGL官方文档
4. **社区支持**：在ESP32和AI相关论坛求助

### 参考资源
- [ESP-DL官方文档](https://docs.espressif.com/projects/esp-dl/)
- [LVGL图形库文档](https://docs.lvgl.io/)
- [ESP32-S3技术参考手册](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/)
- [YOLO姿态检测介绍](https://github.com/ultralytics/ultralytics)

## 🎉 总结

这个项目成功将传统的摄像头显示系统升级为智能坐姿检测平台，结合了：

- **边缘AI计算**：本地实时推理，无需网络连接
- **直观用户界面**：简洁明了的状态显示
- **高度可定制**：灵活的参数调整和功能扩展
- **工业级稳定性**：基于ESP-IDF的可靠运行

无论是用于教育场景中的学生坐姿监控，还是办公环境中的健康提醒，这个系统都能提供有效的技术支持。 